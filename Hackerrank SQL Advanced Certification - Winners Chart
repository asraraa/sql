WITH highest_score AS(
    SELECT event_id, participant_name, MAX(score) as score
    FROM scoretable
    GROUP BY event_id, participant_name
),
rank_no AS(
    SELECT event_id, participant_name, score,
    DENSE_RANK() OVER (
        PARTITION BY event_id 
        ORDER BY score DESC
    ) AS rank_within_event
    FROM highest_score
),
grouped_ranks AS (
  SELECT 
    event_id,
    rank_within_event,
    LISTAGG(participant_name, ',') WITHIN GROUP (ORDER BY participant_name) AS participants
  FROM rank_no
  GROUP BY event_id, rank_within_event
)
SELECT
  event_id,
  MAX(CASE WHEN rank_within_event = 1 THEN participants END) AS first_winner,
  MAX(CASE WHEN rank_within_event = 2 THEN participants END) AS second_winner,
  MAX(CASE WHEN rank_within_event = 3 THEN participants END) AS third_winner
FROM grouped_ranks
GROUP BY event_id
ORDER BY event_id;
